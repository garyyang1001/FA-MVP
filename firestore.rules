rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ===================
    // 輔助函數
    // ===================
    
    // 檢查用戶是否已登入
    function isSignedIn() {
      return request.auth != null;
    }
    
    // 檢查是否為資源擁有者
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // 檢查是否為有效的用戶 UID
    function isValidUser(userId) {
      return userId is string && userId.size() > 0;
    }
    
    // 檢查時間戳是否為當前時間（允許一些時間偏差）
    function isValidTimestamp(timestamp) {
      return timestamp is timestamp && 
             timestamp > request.time.toMillis() - 60000 && // 不能超過 1 分鐘前
             timestamp < request.time.toMillis() + 60000;   // 不能超過 1 分鐘後
    }

    // ===================
    // 用戶集合規則
    // ===================
    
    match /users/{userId} {
      // 讀取權限：只有本人能讀取自己的完整資料
      allow read: if isSignedIn() && isOwner(userId);
      
      // 創建權限：只能創建自己的用戶資料
      allow create: if isSignedIn() && 
                   isOwner(userId) &&
                   isValidUser(userId) &&
                   // 檢查必要欄位
                   resource.data.keys().hasAll(['uid', 'email', 'displayName', 'createdAt']) &&
                   resource.data.uid == userId &&
                   resource.data.email == request.auth.token.email;
      
      // 更新權限：只能更新自己的資料，且不能修改某些關鍵欄位
      allow update: if isSignedIn() && 
                   isOwner(userId) &&
                   // 不能修改這些關鍵欄位
                   !('uid' in resource.data.diff(request.resource.data).affectedKeys()) &&
                   !('email' in resource.data.diff(request.resource.data).affectedKeys()) &&
                   !('createdAt' in resource.data.diff(request.resource.data).affectedKeys());
      
      // 刪除權限：暫時不允許刪除用戶資料
      allow delete: if false;
    }

    // ===================
    // 遊戲集合規則
    // ===================
    
    match /games/{gameId} {
      // 讀取權限：
      // - 公開遊戲：任何人都可以讀取
      // - 私人遊戲：只有創作者可以讀取
      allow read: if resource.data.isPublic == true || 
                     (isSignedIn() && isOwner(resource.data.userId));
      
      // 創建權限：只有登入用戶可以創建，且必須是自己的遊戲
      allow create: if isSignedIn() && 
                   isOwner(resource.data.userId) &&
                   // 檢查必要欄位
                   resource.data.keys().hasAll([
                     'userId', 'gameConfig', 'creationHighlights', 
                     'shareText', 'createdAt', 'isPublic', 'isActive'
                   ]) &&
                   // 檢查資料類型
                   resource.data.userId is string &&
                   resource.data.gameConfig is map &&
                   resource.data.creationHighlights is list &&
                   resource.data.shareText is string &&
                   resource.data.isPublic is bool &&
                   resource.data.isActive is bool &&
                   // 初始值檢查
                   resource.data.playCount == 0 &&
                   resource.data.shareCount == 0 &&
                   resource.data.likeCount == 0;
      
      // 更新權限：
      // - 創作者可以更新自己的遊戲
      // - 但不能修改某些統計欄位（這些由系統更新）
      allow update: if isSignedIn() && 
                   isOwner(resource.data.userId) &&
                   // 不能直接修改這些統計欄位
                   !('playCount' in resource.data.diff(request.resource.data).affectedKeys()) &&
                   !('shareCount' in resource.data.diff(request.resource.data).affectedKeys()) &&
                   !('likeCount' in resource.data.diff(request.resource.data).affectedKeys()) &&
                   !('createdAt' in resource.data.diff(request.resource.data).affectedKeys()) &&
                   !('userId' in resource.data.diff(request.resource.data).affectedKeys());
      
      // 刪除權限：只有創作者可以刪除自己的遊戲
      allow delete: if isSignedIn() && isOwner(resource.data.userId);
    }

    // ===================
    // 遊戲遊玩記錄規則
    // ===================
    
    match /gamePlays/{playId} {
      // 讀取權限：
      // - 遊戲創作者可以查看自己遊戲的所有遊玩記錄
      // - 遊玩者可以查看自己的遊玩記錄
      allow read: if isSignedIn() && 
                     (isOwner(resource.data.playerId) || 
                      isGameOwner(resource.data.gameId));
      
      // 創建權限：任何人都可以創建遊玩記錄（包括匿名用戶）
      allow create: if resource.data.keys().hasAll(['gameId', 'score', 'duration', 'completedAt']) &&
                   resource.data.gameId is string &&
                   resource.data.score is number &&
                   resource.data.duration is number &&
                   resource.data.score >= 0 &&
                   resource.data.duration > 0;
      
      // 更新權限：只有記錄擁有者可以更新（主要是為了添加評價）
      allow update: if isSignedIn() && isOwner(resource.data.playerId);
      
      // 刪除權限：記錄擁有者或遊戲創作者可以刪除
      allow delete: if isSignedIn() && 
                   (isOwner(resource.data.playerId) || 
                    isGameOwner(resource.data.gameId));
    }
    
    // 輔助函數：檢查是否為遊戲擁有者
    function isGameOwner(gameId) {
      return exists(/databases/$(database)/documents/games/$(gameId)) &&
             get(/databases/$(database)/documents/games/$(gameId)).data.userId == request.auth.uid;
    }

    // ===================
    // 分享記錄規則
    // ===================
    
    match /shareRecords/{shareId} {
      // 讀取權限：遊戲創作者可以查看分享記錄統計
      allow read: if isSignedIn() && isGameOwner(resource.data.gameId);
      
      // 創建權限：任何人都可以創建分享記錄
      allow create: if resource.data.keys().hasAll(['gameId', 'platform', 'sharedAt']) &&
                   resource.data.gameId is string &&
                   resource.data.platform is string &&
                   resource.data.sharedAt is timestamp;
      
      // 更新權限：系統自動更新點擊和轉換統計
      allow update: if 'clickCount' in resource.data.diff(request.resource.data).affectedKeys() ||
                   'conversionCount' in resource.data.diff(request.resource.data).affectedKeys();
      
      // 刪除權限：不允許刪除分享記錄
      allow delete: if false;
    }

    // ===================
    // 創作會話規則
    // ===================
    
    match /creationSessions/{sessionId} {
      // 讀取權限：只有會話擁有者可以讀取
      allow read: if isSignedIn() && isOwner(resource.data.userId);
      
      // 創建權限：只能創建自己的會話
      allow create: if isSignedIn() && 
                   isOwner(resource.data.userId) &&
                   resource.data.keys().hasAll(['userId', 'currentStep', 'isCompleted', 'startedAt']) &&
                   resource.data.currentStep >= 0 &&
                   resource.data.isCompleted == false;
      
      // 更新權限：只能更新自己的會話
      allow update: if isSignedIn() && isOwner(resource.data.userId);
      
      // 刪除權限：可以刪除自己的會話
      allow delete: if isSignedIn() && isOwner(resource.data.userId);
    }

    // ===================
    // 默認拒絕規則
    // ===================
    
    // 拒絕所有其他讀寫操作
    match /{document=**} {
      allow read, write: if false;
    }
  }
}